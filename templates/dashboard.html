<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Dashboard</h4>
    <div>
      <span class="text-muted me-3">Eingeloggt als: {{user}}</span>
      <a href="/form" class="btn btn-sm btn-outline-primary me-2">Tagesumsatz erfassen</a>
      <a href="/logout" class="btn btn-sm btn-outline-danger">Logout</a>
    </div>
  </div>

  <!-- FILTER -->
  <form class="row mb-3" method="get" action="/dashboard">
    <div class="col-md-3">
      <label>Jahr wählen</label>
      <select class="form-select" name="jahr">
        {% for j in jahre %}
          <option value="{{j}}" {% if jahr_selected == j %}selected{% endif %}>{{j}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label>Zeitraum</label>
      <select class="form-select" name="filter" onchange="this.form.submit()">
        <option value="monat"     {% if filter=='monat' %}selected{% endif %}>Aktueller Monat</option>
        <option value="jahres"    {% if filter=='jahres' %}selected{% endif %}>Laufendes Jahr</option>
        <option value="quartal1"  {% if filter=='quartal1' %}selected{% endif %}>1. Quartal</option>
        <option value="quartal2"  {% if filter=='quartal2' %}selected{% endif %}>2. Quartal</option>
        <option value="quartal3"  {% if filter=='quartal3' %}selected{% endif %}>3. Quartal</option>
        <option value="quartal4"  {% if filter=='quartal4' %}selected{% endif %}>4. Quartal</option>
        <option value="custom"    {% if filter=='custom' %}selected{% endif %}>Benutzerdefiniert</option>
      </select>
    </div>

    {% if filter=='custom' %}
    <div class="col-md-3">
      <label>von</label>
      <input name="start" class="form-control" value="{{start}}" placeholder="dd.mm.yyyy">
    </div>
    <div class="col-md-3">
      <label>bis</label>
      <input name="end" class="form-control" value="{{end}}" placeholder="dd.mm.yyyy">
    </div>
    <div class="col-md-12 mt-2">
      <button class="btn btn-primary" type="submit">Filtern</button>
    </div>
    {% endif %}
  </form>

  <!-- KARTEN -->
  <div class="row g-3">
    {% for row in stats %}
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">{{row[0]}}</div>
        <div class="card-body"><strong>Umsatz:</strong> CHF {{ "%.2f"|format(row[1]) }}</div>
      </div>
    </div>
    {% endfor %}
    <div class="col-md-12 mt-3">
      <div class="alert alert-secondary"><strong>Gesamt (alle): CHF {{ "%.2f"|format(gesamt) }}</strong></div>
    </div>
  </div>

  <!-- ADMIN BEREICH -->
  {% if user == 'admin_sebastiano' %}
  <hr class="mt-4">

  <h5>Letzte Schichteingaben</h5>
  <table class="table table-sm">
    <thead><tr><th>Restaurant</th><th>Datum</th><th>Betrag [CHF]</th></tr></thead>
    <tbody>
      {% for r,d,b in last_entries %}
      <tr><td>{{r}}</td><td>{{d}}</td><td>{{ "%.2f"|format(b) }}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h5 class="mt-4">Jahresumsatz {{jahr_selected}} pro Restaurant</h5>
  <canvas id="barChart"></canvas>

  <h5 class="mt-4">Monatsentwicklung {{jahr_selected}}</h5>
  <canvas id="lineChart"></canvas>
  {% endif %}

</div>

{% if user == 'admin_sebastiano' %}
<script>
  // Balkenchart
  const labelsBar  = {{ stats|map(attribute=0)|list }};
  const dataBar    = {{ stats|map(attribute=1)|list }};
  new Chart(document.getElementById('barChart'),{
    type:'bar',
    data:{labels:labelsBar,datasets:[{data:dataBar,backgroundColor:'#4e73df'}]},
    options:{indexAxis:'y',plugins:{legend:{display:false}}}
  });

  // Linienchart
  const months=['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
  const monatData={{ monthly }};
  const farben=['#4e73df','#e74a3b','#1cc88a','#f6c23e','#8e44ad'];
  let ds=[],i=0;
  for(const r in monatData){
    ds.push({label:r,data:monatData[r],borderColor:farben[i%farben.length],fill:false,tension:0.25});
    i++;
  }
  new Chart(document.getElementById('lineChart'),{
    type:'line',
    data:{labels:months,datasets:ds},
    options:{plugins:{legend:{position:'bottom'}}}
  });
</script>
{% endif %}
</body>
</html>
